<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üî¥ SIEM Live Stream</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }
        .status {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .status-dot {
            width: 8px; height: 8px; border-radius: 50%;
            background: #48bb78; animation: pulse 2s infinite;
            margin-right: 8px; display: inline-block;
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .events {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        .event {
            border-bottom: 1px solid #e2e8f0;
            padding: 12px 20px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        .event:hover { background: #f8fafc; }
        .timestamp { color: #6b7280; font-weight: bold; }
        .tenant { 
            background: #e1f5fe; color: #0277bd; 
            padding: 2px 8px; border-radius: 12px; 
            font-size: 11px; margin: 0 8px;
        }
        .source { 
            background: #f3e5f5; color: #7b1fa2; 
            padding: 2px 8px; border-radius: 12px; 
            font-size: 11px; margin: 0 8px;
        }
        .message { color: #374151; margin-left: 16px; }
        .controls { margin-bottom: 20px; }
        .btn {
            background: #667eea; color: white; border: none;
            padding: 8px 16px; border-radius: 6px; margin-right: 10px;
            cursor: pointer; font-size: 14px;
        }
        .btn:hover { background: #5a6fd8; }
        .btn.paused { background: #ef4444; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üî¥ SIEM Live Events Stream</h1>
            <p>Real-time security events from ClickHouse database</p>
        </div>

        <div class="controls">
            <button id="pauseBtn" class="btn">‚è∏Ô∏è Pause</button>
            <button id="clearBtn" class="btn">üóëÔ∏è Clear</button>
            <label>
                <input type="checkbox" id="autoScroll" checked> Auto-scroll
            </label>
        </div>

        <div class="status">
            <div id="connectionStatus">
                <span class="status-dot"></span>
                <span>Connecting to live stream...</span>
            </div>
            <div>
                <strong id="eventCount">0</strong> events | 
                <strong id="eventRate">0.0</strong>/sec
            </div>
        </div>

        <div class="events">
            <div id="eventsContainer" style="max-height: 600px; overflow-y: auto;">
                <div class="event">üîå Connecting to live event stream...</div>
            </div>
        </div>
    </div>

    <script>
        let eventCount = 0;
        let isPaused = false;
        const startTime = Date.now();
        const maxEvents = 100;

        // DOM elements
        const connectionStatus = document.getElementById('connectionStatus');
        const eventCountEl = document.getElementById('eventCount');
        const eventRateEl = document.getElementById('eventRate');
        const eventsContainer = document.getElementById('eventsContainer');
        const pauseBtn = document.getElementById('pauseBtn');
        const clearBtn = document.getElementById('clearBtn');
        const autoScrollEl = document.getElementById('autoScroll');

        // Connect to ClickHouse SSE stream
        const eventSource = new EventSource('http://localhost:8080/api/v1/events/stream/ch');

        eventSource.onopen = function() {
            connectionStatus.innerHTML = '<span class="status-dot"></span>‚úÖ Connected - Live Stream Active';
        };

        eventSource.onmessage = function(event) {
            if (isPaused) return;

            try {
                const eventData = JSON.parse(event.data);
                eventCount++;

                // Create event element
                const eventEl = document.createElement('div');
                eventEl.className = 'event';
                
                const timestamp = new Date(eventData.event_timestamp * 1000).toISOString();
                const truncatedMessage = eventData.raw_event.length > 150 ? 
                    eventData.raw_event.substring(0, 150) + '...' : eventData.raw_event;

                eventEl.innerHTML = `
                    <span class="timestamp">${timestamp}</span>
                    <span class="tenant">${eventData.tenant_id}</span>
                    <span class="source">${eventData.source_type}</span>
                    <div class="message">${truncatedMessage}</div>
                `;

                // Add to container
                if (eventsContainer.firstChild && eventsContainer.firstChild.textContent.includes('Connecting')) {
                    eventsContainer.innerHTML = '';
                }
                eventsContainer.insertBefore(eventEl, eventsContainer.firstChild);

                // Limit events
                while (eventsContainer.children.length > maxEvents) {
                    eventsContainer.removeChild(eventsContainer.lastChild);
                }

                // Auto-scroll to top
                if (autoScrollEl.checked) {
                    eventsContainer.scrollTop = 0;
                }

                // Update metrics
                const elapsedSeconds = (Date.now() - startTime) / 1000;
                const rate = elapsedSeconds > 0 ? (eventCount / elapsedSeconds) : 0;
                
                eventCountEl.textContent = eventCount.toLocaleString();
                eventRateEl.textContent = rate.toFixed(1);

            } catch (error) {
                console.error('Error parsing event:', error);
            }
        };

        eventSource.onerror = function(error) {
            connectionStatus.innerHTML = '<span class="status-dot"></span>‚ùå Connection Error - Retrying...';
            console.error('EventSource error:', error);
        };

        // Controls
        pauseBtn.addEventListener('click', function() {
            isPaused = !isPaused;
            if (isPaused) {
                pauseBtn.textContent = '‚ñ∂Ô∏è Resume';
                pauseBtn.className = 'btn paused';
                connectionStatus.innerHTML = '<span class="status-dot"></span>‚è∏Ô∏è Stream Paused';
            } else {
                pauseBtn.textContent = '‚è∏Ô∏è Pause';
                pauseBtn.className = 'btn';
                connectionStatus.innerHTML = '<span class="status-dot"></span>‚úÖ Connected - Live Stream Active';
            }
        });

        clearBtn.addEventListener('click', function() {
            eventsContainer.innerHTML = '<div class="event">üìù Events cleared - waiting for new events...</div>';
            eventCount = 0;
            eventCountEl.textContent = '0';
            eventRateEl.textContent = '0.0';
        });

        // Update rate every second
        setInterval(() => {
            const elapsedSeconds = (Date.now() - startTime) / 1000;
            const rate = elapsedSeconds > 0 ? (eventCount / elapsedSeconds) : 0;
            eventRateEl.textContent = rate.toFixed(1);
        }, 1000);
    </script>
</body>
</html>