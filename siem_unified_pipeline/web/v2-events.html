<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SIEM v2 — Events (Greenfield)</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 16px; }
    h1 { margin-bottom: 12px; }
    .controls { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-bottom: 12px; }
    button { padding: 6px 10px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px; border-bottom: 1px solid #eee; text-align: left; font-size: 13px; }
    th { background: #fafafa; position: sticky; top: 0; }
    .badge { padding: 2px 6px; border-radius: 4px; font-size: 12px; color: #fff; }
    .sev-low { background: #4caf50; }
    .sev-medium { background: #ff9800; }
    .sev-high { background: #f44336; }
    .sev-critical { background: #b71c1c; }
    .muted { color: #666; font-size: 12px; }
  </style>
</head>
<body>
  <h1>Events (Greenfield) <span class="muted" style="font-weight:400; font-size:14px">· <a href="/dev/apis">API Console</a></span></h1>
  <div style="display:flex; gap:12px; flex-wrap:wrap; margin:10px 0;">
    <div style="background:#f6f8fa; padding:10px 14px; border-radius:8px;">
      <div class="muted">Total Logs</div>
      <div id="card-total" style="font-weight:600; font-size:18px;">—</div>
    </div>
    <div style="background:#f6f8fa; padding:10px 14px; border-radius:8px;">
      <div class="muted">Fetched (Filtered)</div>
      <div id="card-fetched" style="font-weight:600; font-size:18px;">0</div>
    </div>
    <div style="background:#f6f8fa; padding:10px 14px; border-radius:8px;">
      <div class="muted">Real-time EPS</div>
      <div id="card-eps" style="font-weight:600; font-size:18px;">0.0</div>
    </div>
    <div style="background:#f6f8fa; padding:10px 14px; border-radius:8px;">
      <div class="muted">Log Sources</div>
      <div id="card-sources" style="font-weight:600; font-size:18px;">—</div>
    </div>
    <div style="background:#f6f8fa; padding:10px 14px; border-radius:8px;">
      <div class="muted">Size (estimated)</div>
      <div id="card-size" style="font-weight:600; font-size:18px;">—</div>
    </div>
    <div style="background:#f6f8fa; padding:10px 14px; border-radius:8px;">
      <div class="muted">Fetched Size</div>
      <div id="card-size-fetched" style="font-weight:600; font-size:18px;">—</div>
    </div>
    <div style="background:#f6f8fa; padding:10px 14px; border-radius:8px;">
      <div class="muted">Kafka</div>
      <div id="card-kafka" style="font-weight:600; font-size:18px;">—</div>
    </div>
    <div style="background:#f6f8fa; padding:10px 14px; border-radius:8px;">
      <div class="muted">Redis</div>
      <div id="card-redis" style="font-weight:600; font-size:18px;">—</div>
    </div>
    <div style="background:#f6f8fa; padding:10px 14px; border-radius:8px;">
      <div class="muted">Vector</div>
      <div id="card-vector" style="font-weight:600; font-size:18px;">—</div>
    </div>
    <div style="background:#f6f8fa; padding:10px 14px; border-radius:8px;">
      <div class="muted">Parsing</div>
      <div id="card-parsing" style="font-weight:600; font-size:18px;">—</div>
    </div>
    <div style="background:#f6f8fa; padding:10px 14px; border-radius:8px;">
      <div class="muted">CH Status</div>
      <div id="card-ch" style="font-weight:600; font-size:18px;">—</div>
    </div>
    <div style="background:#f6f8fa; padding:10px 14px; border-radius:8px;">
      <div class="muted">CH Storage</div>
      <div id="card-ch-storage" style="font-weight:600; font-size:18px;">—</div>
    </div>
    <div style="background:#f6f8fa; padding:10px 14px; border-radius:8px;">
      <div class="muted">Search Time</div>
      <div id="card-search-time" style="font-weight:600; font-size:18px;">—</div>
    </div>
  </div>
  <div class="controls">
    <label>Time:
      <select id="time">
        <option value="1h" selected>Last 1h</option>
        <option value="5m">Last 5m</option>
        <option value="15m">Last 15m</option>
        <option value="30m">Last 30m</option>
        <option value="3h">Last 3h</option>
        <option value="1d">Last 1d</option>
        <option value="3d">Last 3d</option>
        <option value="7d">Last 7d</option>
        <option value="all">All time</option>
      </select>
    </label>
    <label>Search (AND/OR): <input id="q" placeholder="e.g. error OR login" style="min-width:260px"/></label>
    <button id="apply">Apply</button>
    <button id="prev">Prev</button>
    <button id="next">Next</button>
    <span class="muted" id="pageinfo">Page 1</span>
    <button id="export">Export JSON</button>
    <span class="muted" id="status">Ready</span>
  </div>

  <div style="overflow: auto; max-height: 70vh; border: 1px solid #eee;">
    <table>
      <thead>
        <tr>
          <th>Time</th>
          <th>Tenant</th>
          <th>Source</th>
          <th>Severity</th>
          <th>Category</th>
          <th>Action</th>
          <th>User</th>
          <th>Message</th>
          <th>Event ID</th>
        </tr>
      </thead>
      <tbody id="rows">
        <tr><td colspan="9" class="muted">No data</td></tr>
      </tbody>
    </table>
  </div>

  <script>
    const apiBase = '/api/v2/events/search_compact';
    let offset = 0, limit = 1000, totalRendered = 0, page = 1;
    const statusEl = document.getElementById('status');
    const rowsEl = document.getElementById('rows');
    const exported = [];
    const qInput = document.getElementById('q');
    const timeSel = document.getElementById('time');
    const pageInfo = document.getElementById('pageinfo');

    function sevClass(s) {
      if (!s) return 'sev-low';
      s = s.toLowerCase();
      return s === 'critical' ? 'sev-critical' : s === 'high' ? 'sev-high' : s === 'medium' ? 'sev-medium' : 'sev-low';
    }

    function qs(p) { const u = new URLSearchParams(); Object.entries(p).forEach(([k,v])=>{ if(v!==''&&v!=null)u.set(k,String(v)); }); return u.toString(); }

    function calcWindow() {
      const v = timeSel.value;
      if (v === 'all') return { start_time: '', end_time: '' };
      const now = new Date();
      const end_time = now.toISOString();
      const mult = { m: 60_000, h: 3_600_000, d: 86_400_000 };
      const unit = v.slice(-1);
      const n = Number(v.slice(0, -1));
      const ms = (mult[unit] || 0) * n;
      const start_time = new Date(now.getTime() - ms).toISOString();
      return { start_time, end_time };
    }

    async function fetchPage() {
      const t0 = performance.now();
      const { start_time, end_time } = calcWindow();
      const url = `${apiBase}?${qs({ limit, offset, query: (qInput.value || '').trim(), start_time, end_time })}`;
      statusEl.textContent = `Loading page ${page} ...`;
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      const t1 = performance.now();
      const ms = Math.max(0, t1 - t0);
      const st = document.getElementById('card-search-time');
      if (st) st.textContent = `${ms.toFixed(0)} ms`;
      const evs = data.events || [];
      if (offset === 0) { rowsEl.innerHTML = ''; exported.length = 0; totalRendered = 0; }
      const frag = document.createDocumentFragment();
      let batchBytes = 0;
      for (const ev of evs) {
        const tr = document.createElement('tr');
        const ts = ev.event_timestamp ? new Date(ev.event_timestamp * 1000).toLocaleString() : '';
        const sev = ev.severity || '';
        const user = ev.user_name || ev.user_id || '';
        const msg = (ev.message || '').toString();
        tr.innerHTML = `
          <td>${ts}</td>
          <td>${ev.tenant_id || ''}</td>
          <td>${ev.source_type || ''}</td>
          <td><span class="badge ${sevClass(sev)}">${sev || 'low'}</span></td>
          <td>${ev.event_category || ''}</td>
          <td>${ev.event_action || ''}</td>
          <td>${user}</td>
          <td title="${msg.replaceAll('"','&quot;')}">${msg.slice(0, 80)}</td>
          <td title="${ev.event_id}">${String(ev.event_id).slice(0, 12)}…</td>
        `;
        tr.style.cursor = 'pointer';
        tr.addEventListener('click', () => showDetails(ev));
        frag.appendChild(tr);
        exported.push(ev);
        if (typeof ev.raw_len === 'number') batchBytes += ev.raw_len;
      }
      rowsEl.appendChild(frag);
      totalRendered += evs.length;
      document.getElementById('card-fetched').textContent = totalRendered.toLocaleString();
      // Update fetched bytes card (human readable)
      const cur = document.getElementById('card-size-fetched');
      const prevText = cur.textContent;
      const prevBytes = (function parsePrev(t){
        if (!t || t==='—') return 0;
        const m = t.match(/([0-9.]+)\s*(TB|GB|MB|KB|B)/i); if(!m) return 0;
        const n = parseFloat(m[1]); const u = m[2].toUpperCase();
        const f = u==='TB'?1e12:u==='GB'?1e9:u==='MB'?1e6:u==='KB'?1e3:1;
        return Math.round(n*f);
      })(prevText);
      const sum = prevBytes + batchBytes;
      const human = sum > 1e12 ? (sum/1e12).toFixed(2)+' TB' : sum > 1e9 ? (sum/1e9).toFixed(2)+' GB' : sum > 1e6 ? (sum/1e6).toFixed(2)+' MB' : sum > 1e3 ? (sum/1e3).toFixed(2)+' KB' : sum.toLocaleString()+' B';
      cur.textContent = human;
      statusEl.textContent = `Loaded ${evs.length}`;
      pageInfo.textContent = `Page ${page}`;
      return evs.length;
    }

    async function loadPageAndRender(reset=false) {
      if (reset) {
        offset = 0; page = 1;
        const fs = document.getElementById('card-size-fetched');
        if (fs) fs.textContent = '0 B';
      }
      rowsEl.innerHTML = '<tr><td colspan="9" class="muted">Loading…</td></tr>';
      try {
        const n = await fetchPage();
        if (n === 0 && offset > 0) { // no data on this page, step back one
          offset = Math.max(0, offset - limit);
          page = Math.max(1, page - 1);
          await fetchPage();
        }
      } catch (e) {
        statusEl.textContent = 'Error loading';
        console.error(e);
      }
    }

    document.getElementById('apply').addEventListener('click', () => loadPageAndRender(true));
    document.getElementById('prev').addEventListener('click', async () => { if (offset >= limit) { offset -= limit; page = Math.max(1, page - 1); await loadPageAndRender(); } });
    document.getElementById('next').addEventListener('click', async () => { offset += limit; page += 1; await loadPageAndRender(); });
    const startBtn = document.getElementById('start');
    if (startBtn) startBtn.addEventListener('click', () => loadPageAndRender(true));
    document.getElementById('export').addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(exported)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'events_export.json';
      a.click();
      URL.revokeObjectURL(a.href);
    });

    function showDetails(ev) {
      const wrap = document.createElement('div');
      wrap.style.position = 'fixed';
      wrap.style.inset = '0';
      wrap.style.background = 'rgba(0,0,0,0.5)';
      wrap.style.display = 'flex';
      wrap.style.alignItems = 'center';
      wrap.style.justifyContent = 'center';
      const pane = document.createElement('div');
      pane.style.background = '#fff';
      pane.style.padding = '16px';
      pane.style.borderRadius = '8px';
      pane.style.width = '80%';
      pane.style.maxHeight = '80vh';
      pane.style.overflow = 'auto';
      pane.innerHTML = `<pre>${escapeHtml(JSON.stringify(ev, null, 2))}</pre>`;
      wrap.appendChild(pane);
      wrap.addEventListener('click', () => document.body.removeChild(wrap));
      document.body.appendChild(wrap);
    }

    function escapeHtml(str){return str.replace(/[&<>"]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c]));}

    async function refreshCards() {
      try {
        const q = fetch('/api/v2/metrics/quick').then(r=>r.json());
        const e = fetch('/api/v2/metrics/eps').then(r=>r.json());
        const ch = fetch('/api/v2/metrics/ch_status').then(r=>r.json());
        const chs = fetch('/api/v2/metrics/ch_storage').then(r=>r.json());
        const p = fetch('/api/v2/metrics/parsing').then(r=>r.json());
        const sys = fetch('/api/v2/system/config').then(r=>r.json());
        const k = fetch('/api/v2/metrics/kafka').then(r=>r.json());
        const r = fetch('/api/v2/metrics/redis').then(r=>r.json());
        const v = fetch('/api/v2/metrics/vector').then(r=>r.json());
        const [quick, eps, chv, chstore, ps, scfg, kf, rd, vt] = await Promise.all([q, e, ch, chs, p, sys, k, r, v]);
        document.getElementById('card-total').textContent = Number(quick.total_events||0).toLocaleString();
        document.getElementById('card-sources').textContent = Number(quick.source_count||0).toLocaleString();
        const bytes = Number(quick.total_bytes_estimate||0);
        const human = bytes > 1e12 ? (bytes/1e12).toFixed(2)+' TB' : bytes > 1e9 ? (bytes/1e9).toFixed(2)+' GB' : bytes > 1e6 ? (bytes/1e6).toFixed(2)+' MB' : bytes.toLocaleString()+' B';
        document.getElementById('card-size').textContent = human;
        document.getElementById('card-eps').textContent = (eps.global?.current_eps ?? 0).toFixed(2);
        // CH status & storage
        document.getElementById('card-ch').textContent = `${chv.version || 'unknown'} · ${chv.uptime_seconds || 0}s`;
        const b = Number(chstore.bytes_on_disk||0);
        const bh = b > 1e12 ? (b/1e12).toFixed(2)+' TB' : b > 1e9 ? (b/1e9).toFixed(2)+' GB' : b > 1e6 ? (b/1e6).toFixed(2)+' MB' : b.toLocaleString()+' B';
        document.getElementById('card-ch-storage').textContent = `${chstore.database}.${chstore.table}: ${chstore.rows?.toLocaleString?.()||chstore.rows} rows · ${bh}`;
        // Parsing status
        const pr = ps.parsed_ratio ? (ps.parsed_ratio*100).toFixed(1)+'%' : '0%';
        document.getElementById('card-parsing').textContent = `${ps.parsed_events || 0}/${ps.total_events || 0} (${pr})`;
        // System status (prefer live status over env)
        document.getElementById('card-kafka').textContent = kf.configured ? (kf.ok ? `OK (${kf.latency_ms} ms${kf.lag!=null?`, lag ${kf.lag}`:''})` : `Error${kf.error?`: ${kf.error}`:''}`) : 'Not Set';
        document.getElementById('card-redis').textContent = rd.configured ? (rd.ok ? `OK ${rd.version||''} (${rd.latency_ms} ms)` : `Error${rd.error?`: ${rd.error}`:''}`) : 'Not Set';
        document.getElementById('card-vector').textContent = vt.configured ? (vt.ok ? `OK (${vt.latency_ms} ms)` : `Error${vt.error?`: ${vt.error}`:''}`) : 'Not Set';
      } catch {}
    }

    // initial load
    refreshCards();
    loadPageAndRender(true);
    setInterval(refreshCards, 5000);
  </script>
</body>
</html>


