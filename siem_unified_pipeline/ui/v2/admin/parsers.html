<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Parsers Admin</title>
  <link rel="stylesheet" href="/ui/v2/admin/_shared.css"/>
  <style>.modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center}.card{background:#fff;padding:16px;border-radius:6px;min-width:420px}.toast{position:fixed;right:12px;bottom:12px;background:#222;color:#fff;padding:8px 12px;border-radius:4px;display:none}</style>
</head>
<body>
  <header>
    <div class="title">SIEM Admin</div>
    <nav aria-label="Admin">
      <a href="/ui/v2/admin/index.html">Home</a>
      <a href="/ui/v2/admin/tenants.html">Tenants</a>
      <a href="/ui/v2/admin/log-sources.html">Log Sources</a>
      <a href="/ui/v2/admin/parsers.html">Parsers</a>
      <a href="/ui/v2/admin/streaming.html">Streaming</a>
      <a href="/ui/v2/admin/rules.html">Rules</a>
      <a href="/ui/v2/admin/storage.html">Storage</a>
      <a href="/ui/v2/admin/api-keys.html">API Keys</a>
    </nav>
  </header>
  <div class="container" role="main">
    <h2>Parsers</h2>
    <div>
      <label>Search <input id="q" placeholder="name contains..."/></label>
      <label><input type="checkbox" id="inc"/> include body</label>
      <button id="refresh">Refresh</button>
      <button id="new">New Parser</button>
    </div>
    <table id="tbl"><thead><tr><th>id</th><th>name</th><th>version</th><th>kind</th><th>enabled</th><th>updated_at</th><th>actions</th></tr></thead><tbody></tbody></table>
  </div>
  <div id="modal" class="modal" aria-hidden="true"><div class="card">
    <h3 id="m_title">Create Parser</h3>
    <label>Name <input id="m_name"/></label>
    <label>Version <input id="m_ver" type="number" value="1"/></label>
    <label>Kind <input id="m_kind" value="regex"/></label>
    <label>Body <textarea id="m_body" rows="6">{"pattern": "^msg:(.*)$"}</textarea></label>
    <div id="m_body_err" style="color:#b91c1c;display:none">Invalid JSON</div>
    <label>Samples <input id="m_samples" placeholder="msg:hello, msg:world"/></label>
    <div id="m_samples_preview" class="card small"></div>
    <label><input type="checkbox" id="m_enabled" checked/> Enabled</label>
    <div style="margin-top:8px"><button id="m_save">Save</button><button id="m_close">Close</button></div>
  </div></div>
  <div id="toast" class="toast" role="status" aria-live="polite"></div>
  <script>
  (function(){
  const $= window.$ || (s=>document.querySelector(s)); const toast= window.toast || (m=>{const t=$('#toast'); if(!t) return; t.textContent=m;t.style.display='block';setTimeout(()=>t.style.display='none',1500)});
  async function api(p,o){ const r=await fetch(p,{headers:{'content-type':'application/json'},...o}); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }
  async function load(){
    const qs = new URLSearchParams(); const q=$('#q').value.trim(); if(q) qs.set('q',q); if($('#inc').checked) qs.set('include_body','1');
    const j = await api('/api/v2/admin/parsers'+(qs.toString()?('?'+qs.toString()):''));
    const tb=$('#tbl tbody'); tb.innerHTML=(j.items||[]).map(x=>`<tr>
    <td>${x.parser_id}</td><td>${x.name}</td><td>${x.version}</td><td>${x.kind}</td><td>${x.enabled? 'yes':'no'}</td><td>${x.updated_at}</td>
    <td><button data-act="edit" data-id="${x.parser_id}">Edit</button> <button data-act="del" data-id="${x.parser_id}">Delete</button></td>
    </tr>`).join('');
    tb.querySelectorAll('button').forEach(b=> b.onclick = onRow);
  }
  function updateSamplesPreview(){ const s=$('#m_samples').value.split(',').map(x=>x.trim()).filter(Boolean); $('#m_samples_preview').innerHTML = '<div class="row"><strong>Samples</strong></div>'+ (s.length? ('<ul>'+s.map(x=>`<li>${x}</li>`).join('')+'</ul>') : '<div class="small">No samples</div>'); }
  $('#m_samples').addEventListener('input', updateSamplesPreview);
  function parseBodyOrErr(){ try{ const v=JSON.parse($('#m_body').value||'{}'); $('#m_body_err').style.display='none'; return v; }catch{ $('#m_body_err').style.display='block'; throw new Error('Invalid JSON'); } }
  async function onRow(e){ const id=e.currentTarget.getAttribute('data-id'); const act=e.currentTarget.getAttribute('data-act'); if(act==='del'){ await api('/api/v2/admin/parsers/'+id,{method:'DELETE'}); toast('Deleted'); await load(); return; } const j = await api('/api/v2/admin/parsers/'+id+'?include_body=1'); $('#m_title').textContent='Edit Parser'; $('#m_name').value=j.name; $('#m_ver').value=j.version; $('#m_kind').value=j.kind; $('#m_body').value=j.body; $('#m_samples').value=(j.samples||[]).join(', '); updateSamplesPreview(); $('#m_enabled').checked=!!j.enabled; $('#modal').style.display='flex'; $('#m_save').onclick = async ()=>{ try{ const body=parseBodyOrErr(); const samples=$('#m_samples').value.split(',').map(s=>s.trim()).filter(Boolean); await api('/api/v2/admin/parsers/'+id,{method:'PUT', body: JSON.stringify({ name:$('#m_name').value.trim(), version:parseInt($('#m_ver').value,10)||1, kind:$('#m_kind').value.trim(), body, samples, enabled: $('#m_enabled').checked?1:0 })}); toast('Updated'); $('#modal').style.display='none'; await load(); }catch(err){ toast(String(err)); } } }
  $('#new').onclick = ()=>{ $('#m_title').textContent='Create Parser'; $('#m_name').value=''; $('#m_ver').value=1; $('#m_kind').value='regex'; $('#m_body').value='{"pattern":"^msg:(.*)$"}'; $('#m_samples').value='msg:hello'; updateSamplesPreview(); $('#m_enabled').checked=true; $('#modal').style.display='flex'; $('#m_save').onclick = async ()=>{ try{ const body=parseBodyOrErr(); const samples=$('#m_samples').value.split(',').map(s=>s.trim()).filter(Boolean); await api('/api/v2/admin/parsers',{method:'POST', body: JSON.stringify({ name:$('#m_name').value.trim(), version:parseInt($('#m_ver').value,10)||1, kind:$('#m_kind').value.trim(), body, samples, enabled: $('#m_enabled').checked?1:0 })}); toast('Created'); $('#modal').style.display='none'; await load(); }catch(err){ toast(String(err)); } } };
  $('#m_close').onclick=()=>$('#modal').style.display='none';
  $('#refresh').onclick=load; $('#inc').onchange=load; load().catch(err=>toast(String(err)));
  })();
  </script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Parsers</title>
  <link rel="stylesheet" href="/ui/assets/style.css"/>
</head>
<body>
  <nav><a href="/dev/admin/index.html">Admin</a></nav>
  <main>
    <h1>Parsers</h1>
    <textarea id="sample" rows="6" cols="80" placeholder="Paste raw log"></textarea>
    <div>
      <button data-testid="btn-detect" id="detect">Detect</button>
      <button data-testid="btn-normalize" id="normalize">Normalize</button>
    </div>
    <pre id="out" data-testid="json-preview"></pre>
    <table data-testid="table-coverage" id="cov"><thead><tr><th>Field</th><th>% Present</th></tr></thead><tbody></tbody></table>
    <div id="toast" data-testid="toast"></div>
  </main>
  <script>
  function toast(m){ const t=document.getElementById('toast'); t.textContent=m; setTimeout(()=>t.textContent='',3000); }
  async function call(path){
    const body = { sample: document.getElementById('sample').value };
    const r = await fetch(path, { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(body)});
    const t = await r.text();
    document.getElementById('out').textContent = t;
    return t;
  }
  function renderCoverage(rows){
    const tb = document.querySelector('#cov tbody'); tb.innerHTML='';
    const counts = {}; const total = rows.length||1;
    rows.forEach(o=>{ Object.keys(o).forEach(k=>{ counts[k]=(counts[k]||0)+ (o[k]?1:0); }); });
    Object.entries(counts).forEach(([k,v])=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${k}</td><td>${Math.round(100*v/total)}</td>`; tb.appendChild(tr); });
  }
  document.getElementById('detect').onclick = async ()=>{
    try { await call('/api/v2/parse/detect'); toast('Detect OK'); } catch(e){ toast(e.message); }
  };
  document.getElementById('normalize').onclick = async ()=>{
    try { const t = await call('/api/v2/parse/normalize'); const j=JSON.parse(t||'{}'); const rows=j.rows||[]; renderCoverage(rows); toast('Normalize OK'); } catch(e){ toast(e.message); }
  };
  </script>
</body>
</html>

<!doctype html><html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="stylesheet" href="/ui/v2/admin/_shared.css"/>
<title>Parsers · Admin</title>
</head><body>
<header>
  <div class="title">Parsers</div>
  <nav aria-label="Admin">
    <a href="./index.html">Home</a><a href="./tenants.html">Tenants</a>
    <a href="./log-sources.html">Log Sources</a><a href="./parsers.html">Parsers</a>
    <a href="./cim.html">CIM Explorer</a><a href="./sigma.html">Sigma</a><a href="./ingestors.html">Ingestors</a>
  </nav>
  <div style="margin-left:auto" class="small">Tenant: <input id="tenant" value="default" style="width:120px"/></div>
</header>
<main>
  <section class="card">
    <h3>Catalog</h3>
    <table>
      <thead><tr><th>Vendor</th><th>Type</th><th>Version</th><th>Coverage</th><th>Enabled</th><th>Action</th></tr></thead>
      <tbody id="body"><tr><td colspan="6" class="small">Loading…</td></tr></tbody>
    </table>
  </section>
</main>
<div id="toast" class="toast"></div>
<script src="/ui/v2/admin/_shared.js"></script>
<script>
setCurrentNav('parsers.html');
async function load() {
  try {
    const t = document.querySelector('#tenant').value.trim()||'default';
    const data = await api(`/api/v2/admin/parsers?tenant_id=${encodeURIComponent(t)}`);
    const rows = (data.parsers||[]).map(p => `
      <tr><td>${p.vendor}</td><td>${p.type}</td><td class="small">${p.version||'-'}</td>
      <td><span class="badge">${p.coverage?.toFixed?.(2) ?? '-'}</span></td>
      <td>${p.enabled? 'Yes' : 'No'}</td>
      <td><button data-v="${p.vendor}" data-ty="${p.type}" data-en="${!p.enabled}">${p.enabled?'Disable':'Enable'}</button></td></tr>`);
    document.querySelector('#body').innerHTML = rows.join('') || `<tr><td colspan="6" class="small">No parsers</td></tr>`;
    $all('#body button').forEach(b=> b.onclick = async (e)=>{
      const vendor = b.dataset.v, type=b.dataset.ty, en = (b.dataset.en === 'true'), tenant=document.querySelector('#tenant').value.trim()||'default';
      try {
        await api('/api/v2/admin/parsers/toggle', { method:'POST', body: JSON.stringify({tenant_id:tenant, vendor, type, enabled:en}) });
        toast('Updated','ok'); load();
      } catch(err){ toast(err.message,'error'); }
    });
  } catch(e){
    document.querySelector('#body').innerHTML = `<tr><td colspan="6" class="small">Error: ${e.message}. If endpoint is missing, implement /api/v2/admin/parsers & /parsers/toggle.</td></tr>`;
  }
}
document.querySelector('#tenant').addEventListener('change', load);
load();
</script>
</body></html>

