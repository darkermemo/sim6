<!doctype html><meta charset="utf-8" />
<title>Admin - Tenants</title>
<style>
 body{font:14px system-ui;margin:16px}
 header a{margin-right:12px}
 .card{border:1px solid #e5e7eb;border-radius:12px;padding:12px;margin-bottom:12px}
 .row{display:flex;gap:8px;align-items:center;margin:6px 0}
 .error{color:#b91c1c}
 .ok{color:#065f46}
 input{padding:6px;border:1px solid #d1d5db;border-radius:8px}
 button{padding:6px 10px;border:1px solid #9ca3af;background:#f3f4f6;border-radius:8px;cursor:pointer}
 .list{margin-top:12px}
 table{border-collapse:collapse;width:100%}
 th,td{border:1px solid #e5e7eb;padding:6px}
 .toast{position:fixed;right:12px;top:12px;background:#111827;color:#fff;padding:10px 14px;border-radius:10px;display:none}
</style>
<header>
  <a href="/ui/v2/admin/index.html">Admin</a>
  <a href="/ui/v2/admin/tenants.html">Tenants</a>
  <a href="/ui/v2/admin/sources.html">Sources</a>
  <a href="/ui/v2/admin/parsers.html">Parsers</a>
</header>
<div class="card">
  <h3>Tenants</h3>
  <div class="row">
    <input id="search" placeholder="Search tenant_id or name" size="28" />
    <button id="refresh">Refresh</button>
  </div>
  <div class="row">
    <input id="tenant_id" placeholder="tenant id" size="12" />
    <input id="name" placeholder="name" size="12" />
    <input id="eps_limit" type="number" placeholder="eps" size="6" />
    <input id="burst_limit" type="number" placeholder="burst" size="6" />
    <input id="retention_days" type="number" placeholder="retention_days (1-365)" size="14" />
    <button id="create">Create/Update</button>
  </div>
  <div class="row"><small>Retention TTL preview: <span id="ttl_preview">-</span></small></div>
  <div id="validation" class="error"></div>
  <div class="list">
    <table>
      <thead><tr><th>Tenant</th><th>Name</th><th>EPS</th><th>Burst</th><th>Retention</th><th>Last change</th><th>Actions</th></tr></thead>
      <tbody id="rows"></tbody>
    </table>
  </div>
  <div id="toast" class="toast"></div>
</div>
<script>
const BASE = location.origin;
const toast = (msg, ok=false)=>{ const el=document.getElementById('toast'); el.textContent=msg; el.style.background= ok? '#064e3b':'#111827'; el.style.display='block'; setTimeout(()=>{el.style.display='none'}, 2000); }
const ttlPreview = ()=>{
  const d=parseInt(document.getElementById('retention_days').value||'0',10);
  if (!d || d<1) { document.getElementById('ttl_preview').textContent='-'; return; }
  const now=new Date(); const ttl=new Date(now.getTime()+d*24*3600*1000);
  document.getElementById('ttl_preview').textContent= ttl.toISOString().slice(0,10);
};
['retention_days'].forEach(id=>document.getElementById(id).addEventListener('input', ttlPreview));

function validateForm(){
  const eps=+document.getElementById('eps_limit').value; const burst=+document.getElementById('burst_limit').value; const r=+document.getElementById('retention_days').value;
  const v=[]; if (!(eps>0)) v.push('EPS must be > 0'); if (!(burst>=eps)) v.push('Burst must be ≥ EPS'); if (!(r>=1 && r<=365)) v.push('Retention must be 1..365');
  document.getElementById('validation').textContent=v.join('; ');
  return v.length===0;
}

async function list(){
  const res = await fetch(`${BASE}/api/v2/admin/tenants`);
  const data = await res.json();
  const q=document.getElementById('search').value.toLowerCase();
  const tbody=document.getElementById('rows'); tbody.innerHTML='';
  data.forEach(t=>{
    if(q && !(t.tenant_id.toLowerCase().includes(q) || (t.name||'').toLowerCase().includes(q))) return;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${t.tenant_id}</td><td>${t.name||''}</td><td>${t.eps_limit||''}</td><td>${t.burst_limit||''}</td><td>${t.retention_days||''}</td><td>${t.updated_at||''}</td><td><button data-id="${t.tenant_id}">Edit</button></td>`;
    tr.querySelector('button').onclick=()=>{
      document.getElementById('tenant_id').value=t.tenant_id;
      document.getElementById('name').value=t.name||'';
      document.getElementById('eps_limit').value=t.eps_limit||50;
      document.getElementById('burst_limit').value=t.burst_limit||100;
      document.getElementById('retention_days').value=t.retention_days||30;
      ttlPreview();
    };
    tbody.appendChild(tr);
  });
}

async function save(){
  if(!validateForm()){ toast('Validation failed'); return; }
  const id=document.getElementById('tenant_id').value.trim(); if(!id){ toast('tenant_id required'); return; }
  const payload={ name: document.getElementById('name').value, };
  try {
    const res= await fetch(`${BASE}/api/v2/admin/tenants`, {method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({tenant_id:id, name: payload.name})});
    if(!res.ok && res.status!==409) throw new Error('create failed');
  } catch(e) { /* ignore if exists */ }
  const lim={ eps_limit:+document.getElementById('eps_limit').value, burst_limit:+document.getElementById('burst_limit').value, retention_days:+document.getElementById('retention_days').value };
  try{
    const r= await fetch(`${BASE}/api/v2/admin/tenants/${encodeURIComponent(id)}/limits`, {method:'PUT', headers:{'content-type':'application/json'}, body: JSON.stringify(lim)});
    if(!r.ok) throw new Error('limits save failed');
    toast('Saved', true); await list();
  }catch(e){ toast('Error saving'); }
}

document.getElementById('refresh').onclick=list;
document.getElementById('create').onclick=save;
document.getElementById('search').oninput=list;
list(); ttlPreview();
</script>
<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Admin • Tenants</title>
  <link rel="stylesheet" href="/dev/ui/assets/style.css"/>
</head>
<body>
<div class="container">
  <h1>Tenants</h1>
  <div id="err" class="error" role="alert" aria-live="assertive" style="display:none"></div>
  <table id="tbl" aria-label="Tenants table">
    <thead><tr><th>Tenant</th><th>Status</th><th>Retention</th><th>EPS</th><th>Burst</th><th>Live EPS</th><th>Actions</th></tr></thead>
    <tbody></tbody>
  </table>
</div>
<script>
const $=s=>document.querySelector(s);
const BASE='/api/v2/admin';
async function req(path, init){ const r=await fetch(path,{headers:{'content-type':'application/json'},...init}); if(!r.ok){ const msg='HTTP '+r.status; const err=$('#err'); err.textContent=msg; err.style.display='block'; throw new Error(msg);} return r.json(); }
async function load(){
  const data = await req(`${BASE}/tenants`);
  const rows = data.items||[];
  const tbody = document.querySelector('#tbl tbody');
  const eps = await fetch('/api/v2/metrics/eps').then(r=>r.json()).catch(()=>({per_tenant:{tenants:{}}}));
  const tmap = (eps && eps.per_tenant && eps.per_tenant.tenants) ? eps.per_tenant.tenants : {};
  tbody.innerHTML = rows.map(r=>`<tr>
    <td>${r.tenant_id}</td>
    <td>${r.status}</td>
    <td><input type="number" min="1" value="${r.retention_days}" data-k="retention_days" data-id="${r.tenant_id}"></td>
    <td><input type="number" min="1" value="${r.eps_quota}" data-k="eps_limit" data-id="${r.tenant_id}"></td>
    <td><input type="number" min="1" value="${r.burst_eps}" data-k="burst_limit" data-id="${r.tenant_id}"></td>
    <td><span aria-live="polite">${(tmap[r.tenant_id]?.current_eps ?? 0).toFixed(2)}</span></td>
    <td><button data-id="${r.tenant_id}">Save</button></td>
  </tr>`).join('');
  tbody.querySelectorAll('button').forEach(btn=>{
    btn.onclick = async ()=>{
      const id=btn.getAttribute('data-id');
      const tr=btn.closest('tr');
      const get=(k)=>tr.querySelector(`[data-k="${k}"]`).value;
      const limits={ eps_limit:parseInt(get('eps_limit'),10), burst_limit:parseInt(get('burst_limit'),10), retention_days:parseInt(get('retention_days'),10) };
      try {
        await req(`${BASE}/tenants/${id}/limits`, { method:'PUT', body: JSON.stringify(limits)});
        alert('Saved');
      } catch (e) {
        const err=$('#err'); err.textContent='Save failed: '+e; err.style.display='block';
      }
    };
  });
}
load().catch(()=>{ const e=$('#err'); e.textContent='Failed to load tenants'; e.style.display='block'; });
</script>
</body>
</html>


