<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>API Keys</title>
  <link rel="stylesheet" href="/ui/v2/admin/_shared.css"/>
  <style>
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center}
    .card{background:#fff;padding:16px;border-radius:6px;min-width:360px}
    .toast{position:fixed;right:12px;bottom:12px;background:#222;color:#fff;padding:8px 12px;border-radius:4px;display:none}
  </style>
</head>
<body>
  <header>
    <div class="title">SIEM Admin</div>
    <nav aria-label="Admin">
      <a href="/ui/v2/admin/index.html">Home</a>
      <a href="/ui/v2/admin/tenants.html">Tenants</a>
      <a href="/ui/v2/admin/log-sources.html">Log Sources</a>
      <a href="/ui/v2/admin/parsers.html">Parsers</a>
      <a href="/ui/v2/admin/streaming.html">Streaming</a>
      <a href="/ui/v2/admin/rules.html">Rules</a>
      <a href="/ui/v2/admin/storage.html">Storage</a>
      <a href="/ui/v2/admin/api-keys.html">API Keys</a>
    </nav>
  </header>
  <div class="container" role="main">
    <h2>API Keys</h2>
    <div>
      <label>Tenant <input id="tenant" value="default" aria-label="Tenant"/></label>
      <button id="refresh">Refresh</button>
      <button id="new">New Key</button>
    </div>
    <table id="tbl" aria-label="API Keys table"><thead><tr><th>key_id</th><th>name</th><th>enabled</th><th>updated_at</th><th>actions</th></tr></thead><tbody></tbody></table>
  </div>
  <div id="modal" class="modal" aria-hidden="true" aria-label="Create API Key">
    <div class="card">
      <h3 id="m_title">Create Key</h3>
      <label>Name <input id="m_name"/></label>
      <label>Scopes <input id="m_scopes" placeholder="ingest,admin:read"/></label>
      <label><input type="checkbox" id="m_enabled" checked/> Enabled</label>
      <div style="margin-top:8px">
        <button id="m_save">Save</button>
        <button id="m_close">Close</button>
        <button id="m_copy_token" style="display:none">Copy token</button>
      </div>
      <pre id="m_token" style="margin-top:8px"></pre>
    </div>
  </div>
  <div id="toast" class="toast" role="status" aria-live="polite"></div>
  <script>
    const $ = s => document.querySelector(s);
    const toast = window.toast || (m => { const t=$('#toast'); if(!t) return; t.textContent=m; t.style.display='block'; setTimeout(()=>t.style.display='none', 2000); });
    async function api(p, o){ const r = await fetch(p, {headers:{'content-type':'application/json'}, ...o}); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }
    async function load(){
      const t=$('#tenant').value.trim();
      const j = await api(`/api/v2/admin/api-keys?tenant_id=${encodeURIComponent(t)}`);
      const tb = $('#tbl tbody');
      tb.innerHTML = (j.items||[]).map(x=>`<tr>
        <td>${x.key_id}</td>
        <td>${x.name}</td>
        <td>${x.enabled? 'yes':'no'}</td>
        <td>${x.updated_at}</td>
        <td>
          <button data-act="rotate" data-id="${x.key_id}">Rotate</button>
          <button data-act="toggle" data-enabled="${x.enabled?1:0}" data-id="${x.key_id}">${x.enabled? 'Disable':'Enable'}</button>
          <button data-act="delete" data-id="${x.key_id}">Delete</button>
        </td>
      </tr>`).join('');
      tb.querySelectorAll('button').forEach(b=> b.onclick = onRowAction);
    }
    async function onRowAction(e){
      const id = e.currentTarget.getAttribute('data-id');
      const act = e.currentTarget.getAttribute('data-act');
      const t=$('#tenant').value.trim();
      if(act==='delete'){
        if(!confirm('Are you sure you want to delete this key?')) return;
        await api(`/api/v2/admin/api-keys/${id}?tenant_id=${encodeURIComponent(t)}`, {method:'DELETE'});
        toast('Deleted');
      } else if(act==='toggle'){
        const enabled = e.currentTarget.getAttribute('data-enabled') === '1' || e.currentTarget.textContent==='Disable';
        await api(`/api/v2/admin/api-keys/${id}`, {method:'PUT', body: JSON.stringify({ tenant_id:t, enabled: enabled?0:1 })});
        toast(enabled? 'Disabled':'Enabled');
      } else if(act==='rotate'){
        // create a new key with same name and delete old
        const old = await api(`/api/v2/admin/api-keys/${id}?tenant_id=${encodeURIComponent(t)}`);
        const name = old.name + ' (rotated)';
        const scopes = (old.scopes||[]);
        const c = await api(`/api/v2/admin/api-keys`, {method:'POST', body: JSON.stringify({ tenant_id:t, name, scopes, enabled:1 })});
        await api(`/api/v2/admin/api-keys/${id}?tenant_id=${encodeURIComponent(t)}`, {method:'DELETE'});
        showToken(c.token);
        toast('Rotated');
      }
      await load();
    }
    function showToken(tok){ const p=$('#m_token'); const btn=$('#m_copy_token'); p.textContent = tok? ('token: '+tok):''; btn.style.display = tok? 'inline-block':'none'; $('#modal').style.display='flex'; }
    $('#m_copy_token').onclick = async ()=>{ try{ const tok = ($('#m_token').textContent||'').replace(/^token:\\s*/,''); await navigator.clipboard.writeText(tok); $('#m_token').textContent = 'token: ********'; toast('Token copied'); }catch(e){ toast('Copy failed'); } };
    $('#new').onclick = ()=>{ $('#m_title').textContent='Create Key'; $('#m_name').value=''; $('#m_scopes').value='ingest'; $('#m_enabled').checked=true; $('#m_token').textContent=''; $('#modal').style.display='flex'; };
    $('#m_close').onclick = ()=> $('#modal').style.display='none';
    $('#m_save').onclick = async ()=>{
      try{
        const t=$('#tenant').value.trim();
        const name=$('#m_name').value.trim();
        if(!name){ toast('Name required'); return; }
        const scopes=$('#m_scopes').value.split(',').map(s=>s.trim()).filter(Boolean);
        const enabled=$('#m_enabled').checked?1:0;
        const j = await api('/api/v2/admin/api-keys', {method:'POST', body: JSON.stringify({ tenant_id:t, name, scopes, enabled })});
        showToken(j.token);
        await load();
      }catch(err){ toast(String(err)); }
    };
    $('#refresh').onclick = load;
    load().catch(err=>toast(String(err)));
  </script>
</body>
</html>


