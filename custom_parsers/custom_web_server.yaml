# Custom Web Server Log Parser Configuration
# Handles proprietary web server log format

name: "custom_web_server"
description: "Parser for CustomCorp Web Server logs"
version: "1.0.0"

metadata:
  author: "SIEM Team"
  vendor: "CustomCorp"
  product: "WebServer Pro"
  category: "web_server"
  tags: ["web", "http", "custom"]
  created: "2025-01-21"
  modified: "2025-01-21"

detection:
  required_patterns:
    - '\[WebServer\]'
    - '\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}'
  optional_patterns:
    - 'HTTP/1\.[01]'
    - '\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}'
  exclusion_patterns: []
  min_length: 50
  max_length: 2000
  content_hints: ["webserver", "http"]

extraction:
  primary_pattern: '\[WebServer\] (?P<timestamp>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}) \[(?P<level>\w+)\] Client: (?P<client_ip>\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}):(?P<client_port>\d+) -> Server: (?P<server_ip>\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}):(?P<server_port>\d+) Method: (?P<method>\w+) URL: (?P<url>\S+) Status: (?P<status>\d+) Size: (?P<size>\d+) Agent: "(?P<user_agent>[^"]*)" Referer: "(?P<referer>[^"]*)"'
  fallback_patterns:
    - '\[WebServer\] (?P<timestamp>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}) \[(?P<level>\w+)\] (?P<message>.*)'
  capture_groups:
    timestamp: "timestamp"
    level: "severity"
    client_ip: "source_ip"
    client_port: "source_port"
    server_ip: "destination_ip"
    server_port: "destination_port"
    method: "http_method"
    url: "url"
    status: "http_status_code"
    size: "http_content_length"
    user_agent: "http_user_agent"
    referer: "http_referer"
    message: "message"
  json_paths: {}
  key_value_patterns: []

field_mapping:
  static_fields:
    event_type: "custom_web_server"
    device_vendor: "CustomCorp"
    device_product: "WebServer Pro"
  transformations:
    - source_field: "level"
      target_field: "severity_normalized"
      transformation_type: "ToLower"
      parameters: {}
    - source_field: "url"
      target_field: "url_normalized"
      transformation_type: "RegexReplace"
      parameters:
        pattern: '\?.*'
        replacement: ''
  defaults:
    tenant_id: "default"
    protocol: "HTTP"
  validations:
    source_ip:
      rule_type: "IpAddress"
      required: true
      parameters: {}
    http_status_code:
      rule_type: "NumericRange"
      required: false
      parameters:
        min: "100"
        max: "599"

quality_rules:
  min_fields_high_confidence: 8
  min_fields_medium_confidence: 5
  field_weights:
    source_ip: 0.2
    http_method: 0.15
    url: 0.15
    http_status_code: 0.1
    timestamp: 0.1
  bonus_rules:
    - condition: "has_field:user_agent"
      bonus: 0.1
      description: "Bonus for having user agent"
    - condition: "field_not_empty:url"
      bonus: 0.05
      description: "Bonus for non-empty URL"
  penalty_rules:
    - condition: "has_field:error"
      penalty: 0.1
      description: "Penalty for error conditions"