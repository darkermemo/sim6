<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIEM Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .status {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .status-item {
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 5px;
            border-left: 4px solid #28a745;
        }
        
        .cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
        }
        
        .metric {
            font-size: 2em;
            font-weight: bold;
            color: #3498db;
            text-align: center;
            margin: 10px 0;
        }
        
        .events-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .event-item {
            background: #f8f9fa;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }
        
        .event-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .severity {
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .severity.critical { background: #dc3545; color: white; }
        .severity.high { background: #fd7e14; color: white; }
        .severity.medium { background: #ffc107; color: black; }
        .severity.low { background: #28a745; color: white; }
        .severity.info { background: #17a2b8; color: white; }
        
        .nav {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .nav-link {
            background: rgba(255, 255, 255, 0.9);
            color: #2c3e50;
            padding: 10px 15px;
            text-decoration: none;
            border-radius: 5px;
            transition: all 0.3s ease;
        }
        
        .nav-link:hover {
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .refresh-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .refresh-btn:hover {
            background: #218838;
        }
        
        .loading {
            text-align: center;
            color: #6c757d;
            font-style: italic;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõ°Ô∏è SIEM Dashboard</h1>
            <div class="status">
                <div class="status-item">
                    <strong>Status:</strong> <span id="system-status">Loading...</span>
                </div>
                <div class="status-item">
                    <strong>Version:</strong> <span id="version">Loading...</span>
                </div>
                <div class="status-item">
                    <strong>Last Updated:</strong> <span id="last-updated">Never</span>
                </div>
            </div>
        </div>
        
        <nav class="nav">
            <a href="/dev" class="nav-link">üìä Dashboard</a>
            <a href="/dev/stream" class="nav-link">üì° Live Stream</a>
              <a href="/api/v2/events/search?limit=20" class="nav-link" target="_blank">üìã Events API</a>
              <a href="/api/v2/health" class="nav-link" target="_blank">üíì Health Check</a>
        </nav>
        
        <div class="cards">
            <div class="card">
                <h3>üìà Real-time Metrics (ClickHouse)</h3>
                <div>
                    <strong>Events Per Second:</strong>
                    <div class="metric" id="eps">0.00</div>
                </div>
                <div>
                    <strong>Total Events:</strong>
                    <div class="metric" id="total-events">0</div>
                </div>
                <div>
                    <strong>Events (Last Hour):</strong>
                    <div class="metric" id="hourly-events" style="font-size: 1.2em; color: #28a745;">0</div>
                </div>
                <div style="font-size: 0.9em; color: #6c757d; margin-top: 10px;">
                    Query Time: <span id="query-time">0ms</span>
                </div>
                <button class="refresh-btn" onclick="loadClickHouseMetrics()">Refresh Metrics</button>
            </div>
            
            <div class="card">
                <h3>üîÑ System Health</h3>
                <div id="health-info" class="loading">Loading system health...</div>
            </div>
            
            <div class="card">
                <h3>üìä Top Sources (Last Hour)</h3>
                <div id="top-sources" class="loading">Loading sources...</div>
            </div>
            
            <div class="card">
                <h3>‚ö†Ô∏è Severity Breakdown</h3>
                <div id="severity-breakdown" class="loading">Loading severity data...</div>
            </div>
        </div>
        
        <div class="cards">
            <div class="card">
                <h3>üì° Live Event Stream</h3>
                <div style="margin-bottom: 15px;">
                    <button class="refresh-btn" onclick="toggleEventStream()" id="stream-toggle">Start Stream</button>
                    <span id="stream-status" style="margin-left: 10px; font-size: 0.9em; color: #6c757d;">Disconnected</span>
                </div>
                <div id="live-events" class="events-list" style="max-height: 300px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; padding: 10px;">
                    <div class="loading">Click "Start Stream" to begin receiving live events</div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h3>üìä Recent Events</h3>
            <button class="refresh-btn" onclick="loadEvents()" style="margin-bottom: 15px;">Refresh Events</button>
            <div id="events-container" class="events-list loading">
                Loading events...
            </div>
        </div>
    </div>

    <script>
        let lastEventCount = 0;
        
        async function loadHealth() {
            try {
                  const response = await fetch('/api/v2/health');
                const data = await response.json();
                
                document.getElementById('system-status').textContent = data.status;
                document.getElementById('version').textContent = data.version;
                document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
                
                const healthInfo = document.getElementById('health-info');
                healthInfo.innerHTML = `
                    <div><strong>Status:</strong> ${data.status}</div>
                    <div><strong>Events Count:</strong> ${data.events_count}</div>
                    <div><strong>Timestamp:</strong> ${new Date(data.timestamp).toLocaleString()}</div>
                `;
                healthInfo.className = '';
            } catch (error) {
                console.error('Failed to load health:', error);
                document.getElementById('health-info').innerHTML = 
                    '<div style="color: red;">‚ùå Failed to connect to server</div>';
            }
        }
        
        async function loadMetrics() {
            try {
                  const response = await fetch('/api/v2/metrics/eps');
                const data = await response.json();
                
                document.getElementById('eps').textContent = data.eps.toFixed(2);
                document.getElementById('total-events').textContent = data.total_events;
                
                // Add animation if events increased
                if (data.total_events > lastEventCount) {
                    document.getElementById('total-events').classList.add('pulse');
                    setTimeout(() => {
                        document.getElementById('total-events').classList.remove('pulse');
                    }, 2000);
                }
                lastEventCount = data.total_events;
                
            } catch (error) {
                console.error('Failed to load metrics:', error);
            }
        }
        
        /// Load comprehensive metrics from ClickHouse database
        async function loadClickHouseMetrics() {
            try {
                  const response = await fetch('/api/v2/metrics/eps');
                const data = await response.json();
                
                // Update main metrics
                document.getElementById('eps').textContent = data.eps.toFixed(2);
                document.getElementById('total-events').textContent = data.total_events.toLocaleString();
                document.getElementById('hourly-events').textContent = data.recent_events_1hour.toLocaleString();
                document.getElementById('query-time').textContent = data.query_time_ms + 'ms';
                
                // Add animation if events increased
                if (data.total_events > lastEventCount) {
                    document.getElementById('total-events').classList.add('pulse');
                    setTimeout(() => {
                        document.getElementById('total-events').classList.remove('pulse');
                    }, 2000);
                }
                lastEventCount = data.total_events;
                
                // Update top sources
                const sourcesContainer = document.getElementById('top-sources');
                if (data.top_sources && data.top_sources.length > 0) {
                    sourcesContainer.innerHTML = data.top_sources.map(source => `
                        <div style="display: flex; justify-content: space-between; padding: 8px; background: #f8f9fa; margin-bottom: 5px; border-radius: 3px;">
                            <span><strong>${source.source_type}</strong></span>
                            <span style="color: #007bff;">${source.count.toLocaleString()}</span>
                        </div>
                    `).join('');
                } else {
                    sourcesContainer.innerHTML = '<div class="loading">No source data available</div>';
                }
                
                // Update severity breakdown
                const severityContainer = document.getElementById('severity-breakdown');
                if (data.severity_breakdown && data.severity_breakdown.length > 0) {
                    severityContainer.innerHTML = data.severity_breakdown.map(severity => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: #f8f9fa; margin-bottom: 5px; border-radius: 3px;">
                            <span class="severity ${severity.severity.toLowerCase()}">${severity.severity.toUpperCase()}</span>
                            <span style="color: #007bff; font-weight: bold;">${severity.count.toLocaleString()}</span>
                        </div>
                    `).join('');
                } else {
                    severityContainer.innerHTML = '<div class="loading">No severity data available</div>';
                }
                
            } catch (error) {
                console.error('Failed to load ClickHouse metrics:', error);
                document.getElementById('top-sources').innerHTML = '<div style="color: red;">‚ùå Failed to load sources</div>';
                document.getElementById('severity-breakdown').innerHTML = '<div style="color: red;">‚ùå Failed to load severity data</div>';
            }
        }
        
        async function loadEvents() {
            try {
                  const response = await fetch('/api/v2/events/search?limit=20');
                const events = await response.json();
                
                const container = document.getElementById('events-container');
                
                if (events.length === 0) {
                    container.innerHTML = '<div class="loading">No events yet. Try posting some events to /api/v1/events</div>';
                    return;
                }
                
                container.innerHTML = events
                    .slice(-20) // Show last 20 events
                    .reverse()
                    .map(event => `
                        <div class="event-item">
                            <div class="event-header">
                                <strong>${event.source}</strong>
                                <span class="severity ${event.severity.toLowerCase()}">${event.severity.toUpperCase()}</span>
                            </div>
                            <div>${event.message}</div>
                            <div style="font-size: 0.8em; color: #6c757d; margin-top: 5px;">
                                ${new Date(event.timestamp).toLocaleString()} | ID: ${event.id.substring(0, 8)}...
                            </div>
                        </div>
                    `).join('');
                    
                container.className = 'events-list';
            } catch (error) {
                console.error('Failed to load events:', error);
                document.getElementById('events-container').innerHTML = 
                    '<div style="color: red;">‚ùå Failed to load events</div>';
            }
        }
        
        // Create some sample events for demonstration
        async function createSampleEvents() {
            const sampleEvents = [
                { source: 'firewall', severity: 'high', message: 'Suspicious traffic detected from 192.168.1.100' },
                { source: 'web-server', severity: 'info', message: 'User login successful: admin@example.com' },
                { source: 'database', severity: 'medium', message: 'Query execution time exceeded threshold: 5.2s' },
                { source: 'antivirus', severity: 'critical', message: 'Malware detected: trojan.win32.generic' },
                { source: 'network', severity: 'low', message: 'Bandwidth utilization: 85%' }
            ];
            
            for (const event of sampleEvents) {
                try {
                      // Note: Inserting via API requires full SiemEvent schema; demo disabled by default
                      /* await fetch('/api/v2/events/insert', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                          body: JSON.stringify([event])
                      }); */
                } catch (error) {
                    console.error('Failed to create sample event:', error);
                }
            }
        }
        
        // Real-time event streaming variables
        let eventSource = null;
        let isStreamActive = false;
        let liveEventCount = 0;
        const maxLiveEvents = 50; // Keep only last 50 live events
        
        /// Toggle real-time event streaming
        function toggleEventStream() {
            if (isStreamActive) {
                stopEventStream();
            } else {
                startEventStream();
            }
        }
        
        /// Start real-time event streaming using Server-Sent Events
        function startEventStream() {
            try {
                  eventSource = new EventSource('/api/v2/events/stream/ch');
                
                eventSource.onopen = function(event) {
                    isStreamActive = true;
                    document.getElementById('stream-toggle').textContent = 'Stop Stream';
                    document.getElementById('stream-toggle').style.background = '#dc3545';
                    document.getElementById('stream-status').textContent = 'Connected';
                    document.getElementById('stream-status').style.color = '#28a745';
                    document.getElementById('live-events').innerHTML = '<div class="loading">Waiting for live events...</div>';
                    console.log('Event stream connected');
                };
                
                eventSource.onmessage = function(event) {
                    try {
                        const eventData = JSON.parse(event.data);
                        addLiveEvent(eventData);
                    } catch (error) {
                        console.error('Failed to parse event data:', error);
                    }
                };
                
                eventSource.onerror = function(event) {
                    console.error('Event stream error:', event);
                    document.getElementById('stream-status').textContent = 'Connection Error';
                    document.getElementById('stream-status').style.color = '#dc3545';
                    
                    // Auto-reconnect after 5 seconds
                    setTimeout(() => {
                        if (isStreamActive) {
                            console.log('Attempting to reconnect...');
                            stopEventStream();
                            startEventStream();
                        }
                    }, 5000);
                };
                
            } catch (error) {
                console.error('Failed to start event stream:', error);
                document.getElementById('stream-status').textContent = 'Failed to Connect';
                document.getElementById('stream-status').style.color = '#dc3545';
            }
        }
        
        /// Stop real-time event streaming
        function stopEventStream() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
            isStreamActive = false;
            document.getElementById('stream-toggle').textContent = 'Start Stream';
            document.getElementById('stream-toggle').style.background = '#28a745';
            document.getElementById('stream-status').textContent = 'Disconnected';
            document.getElementById('stream-status').style.color = '#6c757d';
            console.log('Event stream disconnected');
        }
        
        /// Add a new live event to the stream display
        function addLiveEvent(eventData) {
            const container = document.getElementById('live-events');
            
            // Create event element
            const eventElement = document.createElement('div');
            eventElement.className = 'event-item';
            eventElement.style.animation = 'fadeIn 0.5s ease-in';
            
            // Format timestamp
            const timestamp = new Date(eventData.event_timestamp * 1000).toLocaleString();
            
            eventElement.innerHTML = `
                <div class="event-header">
                    <strong>${eventData.source_type || 'Unknown'}</strong>
                    <span class="severity ${(eventData.severity || 'info').toLowerCase()}">${(eventData.severity || 'INFO').toUpperCase()}</span>
                </div>
                <div>${eventData.message || 'No message'}</div>
                <div style="font-size: 0.8em; color: #6c757d; margin-top: 5px;">
                    ${timestamp} | ID: ${(eventData.event_id || 'unknown').toString().substring(0, 8)}...
                </div>
            `;
            
            // Add to container
            if (container.querySelector('.loading')) {
                container.innerHTML = '';
            }
            
            container.insertBefore(eventElement, container.firstChild);
            liveEventCount++;
            
            // Remove old events if we have too many
            while (container.children.length > maxLiveEvents) {
                container.removeChild(container.lastChild);
                liveEventCount--;
            }
            
            // Update stream status with count
            document.getElementById('stream-status').textContent = `Connected (${liveEventCount} events)`;
        }
        
        // Auto-refresh functions
        function startAutoRefresh() {
            // Refresh health and ClickHouse metrics every 15 seconds
            setInterval(() => {
                loadHealth();
                loadClickHouseMetrics();
            }, 15000);
            
            // Refresh static events every 60 seconds
            setInterval(loadEvents, 60000);
        }
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', async () => {
            await loadHealth();
            await loadClickHouseMetrics();
            await loadEvents();
            
            // Create sample events if none exist
              const eventsResponse = await fetch('/api/v2/events/search?limit=1');
            const events = await eventsResponse.json();
            if (events.length === 0) {
                await createSampleEvents();
                setTimeout(() => {
                    loadEvents();
                    loadClickHouseMetrics();
                }, 1000); // Reload after creating samples
            }
            
            startAutoRefresh();
            
            // Cleanup event stream on page unload
            window.addEventListener('beforeunload', () => {
                if (isStreamActive) {
                    stopEventStream();
                }
            });
        });
    </script>
</body>
</html>
