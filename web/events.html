<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SIEM v2 — Events</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 16px; }
    h1 { margin-bottom: 12px; }
    .controls { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-bottom: 12px; }
    input, select, button { padding: 6px 8px; font-size: 14px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px; border-bottom: 1px solid #eee; text-align: left; font-size: 13px; }
    th { background: #fafafa; position: sticky; top: 0; }
    .badge { padding: 2px 6px; border-radius: 4px; font-size: 12px; color: #fff; }
    .sev-low { background: #4caf50; }
    .sev-medium { background: #ff9800; }
    .sev-high { background: #f44336; }
    .sev-critical { background: #b71c1c; }
    .pager { margin-top: 10px; display: flex; gap: 8px; align-items: center; }
    .muted { color: #666; font-size: 12px; }
    .status { margin-left: auto; }
  </style>
</head>
<body>
  <h1>Events</h1>
  <div class="controls">
    <button id="start">Load all</button>
    <button id="stop">Stop</button>
    <span class="muted status" id="status">Ready</span>
    <span class="muted" id="count"></span>
  </div>

  <div style="overflow: auto; max-height: 70vh; border: 1px solid #eee;">
    <table id="events-table">
      <thead>
        <tr>
          <th>Time</th>
          <th>Tenant</th>
          <th>Source</th>
          <th>Severity</th>
          <th>Category</th>
          <th>Action</th>
          <th>User</th>
          <th>Message</th>
          <th>Event ID</th>
        </tr>
      </thead>
      <tbody id="events-body">
        <tr><td colspan="9" class="muted">No data</td></tr>
      </tbody>
    </table>
  </div>

  <div class="pager">
    <span class="muted" id="page-info">Page 0</span>
  </div>

  <script>
    const apiBase = '/api/v2/events/search';
    let offset = 0;
    let page = 0;
    let totalRendered = 0;
    let running = false;
    const limit = 1000; // batch size per request

    function sevClass(sev) {
      if (!sev) return 'sev-low';
      const s = sev.toLowerCase();
      return s === 'critical' ? 'sev-critical' : s === 'high' ? 'sev-high' : s === 'medium' ? 'sev-medium' : 'sev-low';
    }

    function qs(params) {
      const u = new URLSearchParams();
      Object.entries(params).forEach(([k, v]) => {
        if (v !== undefined && v !== null && v !== '') u.set(k, String(v));
      });
      return u.toString();
    }

    async function loadPage() {
      const url = `${apiBase}?${qs({ limit, offset })}`;
      const status = document.getElementById('status');
      status.textContent = `Loading offset ${offset} ...`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      const rows = data.events || [];
      appendRows(rows);
      document.getElementById('page-info').textContent = `Page ${page}`;
      status.textContent = rows.length ? `Loaded ${rows.length}` : 'Done';
      return rows.length;
    }

    function appendRows(rows) {
      const tb = document.getElementById('events-body');
      if (page === 0 && totalRendered === 0) tb.innerHTML = '';
      const frag = document.createDocumentFragment();
      rows.forEach(ev => {
        const ts = ev.event_timestamp ? new Date(ev.event_timestamp * 1000).toLocaleString() : '';
        const sev = ev.severity || '';
        const sevCls = sevClass(sev);
        const user = ev.user_name || ev.user_id || '';
        const msg = ev.message || '';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${ts}</td>
          <td>${ev.tenant_id || ''}</td>
          <td>${ev.source_type || ''}</td>
          <td><span class="badge ${sevCls}">${sev || 'low'}</span></td>
          <td>${ev.event_category || ''}</td>
          <td>${ev.event_action || ''}</td>
          <td>${user}</td>
          <td title="${msg.replaceAll('"','&quot;')}">${msg.slice(0, 80)}</td>
          <td title="${ev.event_id}">${String(ev.event_id).slice(0, 12)}…</td>
        `;
        frag.appendChild(tr);
      });
      tb.appendChild(frag);
      totalRendered += rows.length;
      document.getElementById('count').textContent = `Total rendered: ${totalRendered.toLocaleString()}`;
    }

    async function loadAll() {
      if (running) return;
      running = true;
      offset = 0; page = 0; totalRendered = 0;
      document.getElementById('events-body').innerHTML = '<tr><td colspan="9" class="muted">Loading…</td></tr>';
      try {
        while (running) {
          const n = await loadPage();
          if (n === 0) break;
          offset += limit;
          page += 1;
        }
      } catch (e) {
        document.getElementById('status').textContent = 'Error loading';
      } finally {
        running = false;
      }
    }

    document.getElementById('start').addEventListener('click', loadAll);
    document.getElementById('stop').addEventListener('click', () => { running = false; document.getElementById('status').textContent = 'Stopped'; });

    // auto-start
    loadAll();
  </script>
</body>
</html>


