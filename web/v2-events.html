<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SIEM v2 — Events (Greenfield)</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 16px; }
    h1 { margin-bottom: 12px; }
    .controls { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-bottom: 12px; }
    button { padding: 6px 10px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px; border-bottom: 1px solid #eee; text-align: left; font-size: 13px; }
    th { background: #fafafa; position: sticky; top: 0; }
    .badge { padding: 2px 6px; border-radius: 4px; font-size: 12px; color: #fff; }
    .sev-low { background: #4caf50; }
    .sev-medium { background: #ff9800; }
    .sev-high { background: #f44336; }
    .sev-critical { background: #b71c1c; }
    .muted { color: #666; font-size: 12px; }
  </style>
</head>
<body>
  <h1>Events (Greenfield)</h1>
  <div class="controls">
    <button id="start">Load all</button>
    <button id="stop">Stop</button>
    <span class="muted" id="status">Ready</span>
    <span class="muted" id="count"></span>
  </div>

  <div style="overflow: auto; max-height: 70vh; border: 1px solid #eee;">
    <table>
      <thead>
        <tr>
          <th>Time</th>
          <th>Tenant</th>
          <th>Source</th>
          <th>Severity</th>
          <th>Category</th>
          <th>Action</th>
          <th>User</th>
          <th>Message</th>
          <th>Event ID</th>
        </tr>
      </thead>
      <tbody id="rows">
        <tr><td colspan="9" class="muted">No data</td></tr>
      </tbody>
    </table>
  </div>

  <script>
    const apiBase = '/api/v2/events/search';
    let offset = 0, limit = 1000, running = false, total = 0, page = 0;
    const statusEl = document.getElementById('status');
    const countEl = document.getElementById('count');
    const rowsEl = document.getElementById('rows');

    function sevClass(s) {
      if (!s) return 'sev-low';
      s = s.toLowerCase();
      return s === 'critical' ? 'sev-critical' : s === 'high' ? 'sev-high' : s === 'medium' ? 'sev-medium' : 'sev-low';
    }

    function qs(p) { const u = new URLSearchParams(); Object.entries(p).forEach(([k,v])=>{ if(v!==''&&v!=null)u.set(k,String(v)); }); return u.toString(); }

    async function fetchPage() {
      const url = `${apiBase}?${qs({ limit, offset })}`;
      statusEl.textContent = `Loading offset ${offset}...`;
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      const evs = data.events || [];
      if (page === 0 && total === 0) rowsEl.innerHTML = '';
      const frag = document.createDocumentFragment();
      for (const ev of evs) {
        const tr = document.createElement('tr');
        const ts = ev.event_timestamp ? new Date(ev.event_timestamp * 1000).toLocaleString() : '';
        const sev = ev.severity || '';
        const user = ev.user_name || ev.user_id || '';
        const msg = (ev.message || '').toString();
        tr.innerHTML = `
          <td>${ts}</td>
          <td>${ev.tenant_id || ''}</td>
          <td>${ev.source_type || ''}</td>
          <td><span class="badge ${sevClass(sev)}">${sev || 'low'}</span></td>
          <td>${ev.event_category || ''}</td>
          <td>${ev.event_action || ''}</td>
          <td>${user}</td>
          <td title="${msg.replaceAll('"','&quot;')}">${msg.slice(0, 80)}</td>
          <td title="${ev.event_id}">${String(ev.event_id).slice(0, 12)}…</td>
        `;
        frag.appendChild(tr);
      }
      rowsEl.appendChild(frag);
      total += evs.length; page += 1; offset += limit;
      countEl.textContent = `Total rendered: ${total.toLocaleString()}`;
      statusEl.textContent = evs.length ? `Loaded ${evs.length}` : 'Done';
      return evs.length;
    }

    async function loadAll() {
      if (running) return; running = true; offset = 0; limit = 1000; total = 0; page = 0;
      rowsEl.innerHTML = '<tr><td colspan="9" class="muted">Loading…</td></tr>';
      try {
        while (running) {
          const n = await fetchPage();
          if (n === 0) break;
        }
      } catch (e) {
        statusEl.textContent = 'Error loading';
        console.error(e);
      } finally {
        running = false;
      }
    }

    document.getElementById('start').addEventListener('click', loadAll);
    document.getElementById('stop').addEventListener('click', () => { running = false; statusEl.textContent = 'Stopped'; });

    // auto-start
    loadAll();
  </script>
</body>
</html>


